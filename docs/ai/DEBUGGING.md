# Дебаг‑гайд

Практический чеклист по типовым проблемам генератора.

## Какие логи смотреть

- `[MapGraphLevelSolver] Timings (s): ...`
  - Разрез времени: `precompute`, `solve`, `layout`, `place`, `stamp`.
- `[ConfigSpace] Empty offsets for A -> B`
  - Для пары префабов configuration space (CS) пустое (нет допустимых смещений).
- `[ConfigSpace][dbg] ... => reject ...`
  - Детальная причина, почему конкретная пара сокетов/дельта отбрасывается (включается verbose).
- `[LayoutGenerator] ...`
  - Ошибки генерации кандидатов (`No position candidates`) или провалы `AddChain`.
- `Last failure: Global invalid: disconnected layout ...`
  - Layout найден, но итоговая раскладка не связная (не все комнаты достижимы по “состыкованным” рёбрам).

## Частые причины и что делать

### 1) `Empty offsets for room -> connector`
Типовые причины:
- сокетов нет или направление не совпадает (не opposite)
- сокет стоит “не там” (смещение относительно floor/wall клеток не соответствует правилам)
- на входе конфликтуют стены/пол из‑за того, что carve‑mask не применяется/не учитывается

Что делать:
- включить verbose CS logs и посмотреть первую причину reject
- проверить префаб: сокеты стоят в центрах клеток, `DoorSide` корректный
- проверить, что у коннектора физически есть вход, который может “вкусить” комнату

### 2) Layout не строится на части seed
Типовые причины:
- мало вариантов сокетов (низкая степень свободы)
- слишком маленький бюджет SA (cycles требуют больше поиска)
- генерация кандидатов фильтрует слишком жёстко на ранней стадии

Что делать:
- проверить `MaxLayoutsPerChain`, `TemperatureSteps`, `InnerIterations`
- держать per‑step проверки дешёвыми; строгую валидацию делать только при сохранении результата
- вместо ручного “много сокетов” использовать `DoorSocketSpan`

### 3) Placement падает после успешного layout (overlaps)
Типовые причины:
- layout‑валидация “разрешает” то, что placement запрещает (или наоборот)
- carve‑mask применяется в одном месте, но не применяется в другом

Что делать:
- убедиться, что правила bite/carve одинаковы в:
  - CS computation
  - layout overlap penalty/validation
  - placement overlap checks

## Минимальный “repro bundle” для ИИ

Для бага/перф‑проблемы приложить:
- размер графа и seed
- строку таймингов
- первые `[ConfigSpace]` / `[LayoutGenerator]` warnings
- 1–2 скрина префабов (room + connector) с сокетами и floor/wall Tilemap
